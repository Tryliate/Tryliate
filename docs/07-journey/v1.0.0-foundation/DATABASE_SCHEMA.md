# üóÑÔ∏è Database Schema Reference - Tryliate v1.0.0

This document provides a detailed reference for the database schema used in the Tryliate platform. The architecture follows a **BYOI (Bring Your Own Infrastructure)** model, where most application data is stored in the user's private Supabase instance.

---

## üèóÔ∏è Schema Overview

The Tryliate schema consists of 10 primary tables designed for high isolation, scalability, and real-time connectivity.

### **Entity-Relationship Summary**

- **Workflows** are the central entity.
- **Nodes** and **Edges** belong to a Workflow.
- **MCP Registry** provides shared modules for use in Nodes.
- **Execution Logs** track the history of every step.

---

## üìã Core Tables

### 1. `workflows`
The parent container for visual orchestrations.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `gen_random_uuid()` | Primary key. |
| `name` | `TEXT` | `'Untitled Workflow'` | Display name. |
| `description`| `TEXT` | `NULL` | Optional summary. |
| `state` | `JSONB` | `{viewport: ...}`| Canvas viewport state (x, y, zoom). |
| `created_at` | `TIMESTAMPTZ`| `now()` | Creation timestamp. |
| `updated_at` | `TIMESTAMPTZ`| `now()` | Last modification timestamp. |

### 2. `nodes`
Individual elements within a workflow.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `TEXT` | `REQUIRED` | Unique ID generated by React Flow. |
| `workflow_id` | `UUID` | `REQUIRED` | Foreign key to `workflows.id`. |
| `type` | `TEXT` | `REQUIRED` | Node type (e.g., `protocol`). |
| `data` | `JSONB` | `REQUIRED` | Internal state: label, meta, config. |
| `position_x` | `FLOAT` | `REQUIRED` | X-coordinate on the canvas. |
| `position_y` | `FLOAT` | `REQUIRED` | Y-coordinate on the canvas. |
| `width` | `FLOAT` | `NULL` | Visual width. |
| `height` | `FLOAT` | `NULL` | Visual height. |

### 3. `edges`
Logical connections between workflow nodes.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `TEXT` | `REQUIRED` | Unique ID generated by React Flow. |
| `workflow_id` | `UUID` | `REQUIRED` | Foreign key to `workflows.id`. |
| `source` | `TEXT` | `REQUIRED` | ID of the source node. |
| `target` | `TEXT` | `REQUIRED` | ID of the target node. |
| `source_handle`| `TEXT` | `NULL` | Specific output port ID. |
| `target_handle`| `TEXT` | `NULL` | Specific input port ID. |
| `data` | `JSONB` | `NULL` | Optional connection configuration. |

---

## üîå Integration Tables

### 4. `mcp_registry`
Registry of available MCP servers and tools.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `TEXT` | `REQUIRED` | Unique identifier. |
| `name` | `TEXT` | `REQUIRED` | Display name of the server/tool. |
| `url` | `TEXT` | `NULL` | SSE endpoint URL. |
| `type` | `TEXT` | `'server'` | Category: `server`, `tool`, `client`. |
| `data` | `JSONB` | `NULL` | Metadata (author, description, tags). |

### 5. `mcp_authorizations`
OAuth and API credential management for MCP servers.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `gen_random_uuid()` | Primary key. |
| `user_id` | `UUID` | `REQUIRED` | Supabase auth user ID. |
| `server_name` | `TEXT` | `REQUIRED` | Target server identifier. |
| `status` | `TEXT` | `'idle'` | `idle`, `verified`, `revoked`. |
| `credentials` | `JSONB` | `NULL` | Securely stored tokens. |

---

## ü§ñ Analytics & Intelligence

### 6. `execution_logs`
High-resolution execution tracing.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `gen_random_uuid()` | Primary key. |
| `execution_id`| `TEXT` | `REQUIRED` | Inngest execution ID. |
| `step_name` | `TEXT` | `REQUIRED` | Internal step identifier. |
| `payload` | `JSONB` | `NULL` | Step inputs/outputs/errors. |
| `created_at` | `TIMESTAMPTZ`| `now()` | Log entry timestamp. |

### 7. `flow_space`
AI Assistant (Trymate) persistent conversation context.

| Column | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `gen_random_uuid()` | Primary key. |
| `thread_id` | `TEXT` | `REQUIRED` | Conversation thread identifier. |
| `context` | `JSONB` | `REQUIRED` | Serialized graph state or AI memory. |

---

## üõ°Ô∏è Security Policies (RLS)

All tables implement **Row-Level Security** to ensure data isolation:

1.  **Workflows/Nodes/Edges**: Accessible only to the authenticated user who created them (matched by `user_id` where applicable, or by virtue of being in a private BYOI schema).
2.  **Registry**: Read-only access for all authenticated users; write access reserved for admin roles.
3.  **Logs**: Append-only; viewable only by the owner of the execution.

---

## ‚ö° Realtime Configuration

Tryliate utilizes **Supabase Realtime** for the "Neural Transition" effect. The following tables are members of the `supabase_realtime` publication:
- `workflows`
- `nodes`
- `edges`
- `users` (specific fields)
